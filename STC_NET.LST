C51 COMPILER V9.01   STC_NET                                                               11/04/2018 20:46:39 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE STC_NET
OBJECT MODULE PLACED IN STC_NET.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE STC_NET.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "STC_NET.h"
   2          //========================================================================
   3          // 函数: void PrintString1(u8 *puts)
   4          // 描述: 串口1发送字符串函数。
   5          // 参数: puts:  字符串指针.
   6          // 返回: none.
   7          // 版本: VER1.0
   8          // 日期: 2014-11-28
   9          // 备注: 
  10          //========================================================================
  11          void PrintString1(u8 *puts) //发送一个字符串
  12          {
  13   1          for (; *puts != 0;  puts++)     //遇到停止符0结束
  14   1          {
  15   2              SBUF = *puts;
  16   2              B_TX1_Busy = 1;
  17   2              while(B_TX1_Busy);
  18   2          }
  19   1      }
  20          
  21          //========================================================================
  22          // 函数: SetTimer2Baudraye(u16 dat)
  23          // 描述: 设置Timer2做波特率发生器。
  24          // 参数: dat: Timer2的重装值.
  25          // 返回: none.
  26          // 版本: VER1.0
  27          // 日期: 2014-11-28
  28          // 备注: 
  29          //========================================================================
  30          void    SetTimer2Baudraye(u16 dat)  // 选择波特率, 2: 使用Timer2做波特率, 其它值: 使用Timer1做波特率.
  31          {
  32   1          AUXR &= ~(1<<4);    //Timer stop
  33   1          AUXR &= ~(1<<3);    //Timer2 set As Timer
  34   1          AUXR |=  (1<<2);    //Timer2 set as 1T mode
  35   1          TH2 = dat / 256;
  36   1          TL2 = dat % 256;
  37   1          IE2  &= ~(1<<2);    //禁止中断
  38   1          AUXR |=  (1<<4);    //Timer run enable
  39   1      }
  40          
  41          //========================================================================
  42          // 函数: void   UART1_config(u8 brt)
  43          // 描述: UART1初始化函数。
  44          // 参数: brt: 选择波特率, 2: 使用Timer2做波特率, 其它值: 使用Timer1做波特率.
  45          // 返回: none.
  46          // 版本: VER1.0
  47          // 日期: 2014-11-28
  48          // 备注: 
  49          //========================================================================
  50          void    UART1_config(u8 brt)    // 选择波特率, 2: 使用Timer2做波特率, 其它值: 使用Timer1做波特率.
  51          {
  52   1          /*********** 波特率使用定时器2 *****************/
  53   1          if(brt == 2)
  54   1          {
  55   2              AUXR |= 0x01;       //S1 BRT Use Timer2;
C51 COMPILER V9.01   STC_NET                                                               11/04/2018 20:46:39 PAGE 2   

  56   2              SetTimer2Baudraye(65536UL - (MAIN_Fosc / 4) / Baudrate1);
  57   2          }
  58   1      
  59   1          /*********** 波特率使用定时器1 *****************/
  60   1          else
  61   1          {
  62   2              TR1 = 0;
  63   2              AUXR &= ~0x01;      //S1 BRT Use Timer1;
  64   2              AUXR |=  (1<<6);    //Timer1 set as 1T mode
  65   2              TMOD &= ~(1<<6);    //Timer1 set As Timer
  66   2              TMOD &= ~0x30;      //Timer1_16bitAutoReload;
  67   2              TH1 = (u8)((65536UL - (MAIN_Fosc / 4) / Baudrate1) / 256);
  68   2              TL1 = (u8)((65536UL - (MAIN_Fosc / 4) / Baudrate1) % 256);
  69   2              ET1 = 0;    //禁止中断
  70   2              INT_CLKO &= ~0x02;  //不输出时钟
  71   2              TR1  = 1;
  72   2          }
  73   1          /*************************************************/
  74   1      
  75   1          SCON = (SCON & 0x3f) | 0x40;    //UART1模式, 0x00: 同步移位输出, 0x40: 8位数据,可变波特率, 0x80: 9位数
             -据,固定波特率, 0xc0: 9位数据,可变波特率
  76   1      //  PS  = 1;    //高优先级中断
  77   1          ES  = 1;    //允许中断
  78   1          REN = 1;    //允许接收
  79   1          P_SW1 &= 0x3f;
  80   1          P_SW1 |= 0x80;      //UART1 switch to, 0x00: P3.0 P3.1, 0x40: P3.6 P3.7, 0x80: P1.6 P1.7 (必须使用内部
             -时钟)
  81   1      //  PCON2 |=  (1<<4);   //内部短路RXD与TXD, 做中继, ENABLE,DISABLE
  82   1      
  83   1          B_TX1_Busy = 0;
  84   1          TX1_Cnt = 0;
  85   1          RX1_Cnt = 0;
  86   1      }
  87          
  88          
  89          //========================================================================
  90          // 函数: void UART1_int (void) interrupt UART1_VECTOR
  91          // 描述: UART1中断函数。
  92          // 参数: nine.
  93          // 返回: none.
  94          // 版本: VER1.0
  95          // 日期: 2014-11-28
  96          // 备注: 
  97          //========================================================================
  98          void UART1_int (void) interrupt 4
  99          {
 100   1          if(RI)
 101   1          {
 102   2              RI = 0;
 103   2              RX1_Buffer[RX1_Cnt] = SBUF;
 104   2              if(++RX1_Cnt >= UART1_BUF_LENGTH)   RX1_Cnt = 0;    //防溢出
 105   2          }
 106   1      
 107   1          if(TI)
 108   1          {
 109   2              TI = 0;
 110   2              B_TX1_Busy = 0;
 111   2          }
 112   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.01   STC_NET                                                               11/04/2018 20:46:39 PAGE 3   

   CODE SIZE        =    163    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =     32    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
